## DeepReader 项目评审 -- 问题与任务分配

### 当前核心问题总结

通过代码走查，我发现当前唯一的页面 (`web/app/page.tsx`) 存在严重的**职责混乱**问题：「从 ArXiv 抓取论文」和「浏览/筛选本地论文」这两个完全不同的用户操作，被塞在同一个表单里。下面是具体的问题和分配给前后端的任务。

------

### 给后端工程师的要求

**【后端 #1】新增任务状态追踪系统**

当前 `POST /api/trigger` 使用 FastAPI 的 `BackgroundTasks`（`server/app.py:100`），属于"发射后不管"模式。后端必须实现一个 Job 状态管理机制：

- 新增内存级或数据库级的 job store（如 dict 或新建 `jobs` 表）
- `POST /api/trigger` 返回一个 `job_id`
- 新增 `GET /api/jobs/{job_id}` 端点，返回任务状态（`pending` / `running` / `completed` / `failed`）、已处理论文数、新增论文数、错误信息等
- 在 `core_loop.py` 的循环中（当前第 63-98 行逐篇处理论文），每处理一篇就更新 job 进度

**【后端 #2】修复 `days` 参数的实际语义与传递链路**

追踪代码发现：`core_loop.py:37` 中 `days` 仅在 `start_date` 和 `end_date` 都未提供时才生效，作为 fallback。但前端将 `days` 和日期范围放在同一个表单里，用户不知道二者是互斥关系。后端需要：

- 明确 API 文档：`days` 与 `start_date/end_date` 互斥，当两者同时存在时返回 `400 Bad Request` 而非静默忽略 `days`
- 在 `trigger_fetch` 端点做参数校验

**【后端 #3】分页接口补充 `total` 信息的利用引导**

当前 `GET /api/papers` 已经返回 `total` 字段（`server/app.py:82`），这是好的。但需要确认：

- 当 `topic` 筛选包含多个关键词时（`db_manager.py:229-238`），用 `LIKE` 做模糊匹配的性能在数据量增长后是否可接受
- 考虑对 `published_date` 加索引以加速日期范围查询

**【后端 #4】重构 `/api/trigger` 的请求参数结构**

当前 `TriggerRequest`（`server/app.py:44-50`）将抓取参数和查看参数混在一起。建议拆分为更清晰的结构：

- `query`（自定义查询，最高优先级）
- `category`（分类，必填）
- 时间范围二选一：`days` 或 `{start_date, end_date}`
- `topic`（关键词，可选）
- `max_results`（最大抓取数量，当前在 `core_loop.py:54` 硬编码为 200，应暴露给前端）

**【后端 #5】新增 `GET /api/stats` 端点**

提供一个轻量级统计接口，返回：

- 论文总数
- 最近一次抓取时间
- 按分类统计的论文数量
- 有 AI 摘要 vs 无 AI 摘要的论文数量

用于前端 Dashboard 展示。

------

### 给前端工程师的要求

**【前端 #1】将「抓取」和「浏览」彻底分离**

当前 `page.tsx` 中一个表单同时控制两件事，标签如 `"Topic / Keyword (Search & Fetch)"`（第 138 行）和 `"Start Date (View)"`（第 149 行）令人困惑。要求：

- **浏览区**（主体）：只包含本地论文的筛选（关键词搜索、日期范围、分类筛选）+ 论文列表 + 分页
- **抓取区**：独立的抽屉(Drawer)或可折叠面板，包含抓取参数（分类、时间范围/天数、关键词）和抓取按钮
- 两个区域的表单状态完全独立，不要共用 `topic`、`startDate` 等 state

**【前端 #2】实现抓取任务的进度反馈**

当前用户点击 "Fetch & Analyze New Papers" 后（`page.tsx:55-85`），只收到一个 `alert()`，然后一无所知。要求：

- 触发抓取后，使用后端返回的 `job_id` 轮询 `GET /api/jobs/{job_id}`
- 在页面上显示实时进度条或状态文字，如："正在抓取... 已处理 45/200 篇，新增 12 篇"
- 任务完成后自动刷新论文列表，不需要用户手动点 "Refresh View"
- 任务失败时展示错误信息，不要用 `alert()`

**【前端 #3】实现分页功能**

当前 `fetchPapers` 硬编码 `limit: '20'`（`page.tsx:28`），且没有分页 UI。后端已支持 `offset` 参数且返回 `total`。要求：

- 显示 "共 X 篇论文，当前第 Y-Z 篇" 的统计信息
- 实现上一页/下一页控制（或"加载更多"按钮）
- 让用户清楚知道当前看到的是不是全部结果

**【前端 #4】去掉 "Days to Fetch" 在浏览筛选区的位置**

当前 `daysToFetch` 在筛选表单里（`page.tsx:167-175`），但它不影响浏览筛选（`GET /api/papers` 根本没有 `days` 参数）。它只在 `handleTrigger` 中使用。要求：

- 将 "Days to Fetch" 移到抓取面板中
- 在抓取面板中，日期范围和天数做成互斥的 Tab 或 Radio 切换，不能同时填写
- 去掉当前筛选表单中与抓取相关的字段

**【前端 #5】PaperCard 摘要的展开/折叠**

当前 `PaperCard.tsx` 中 AI 摘要（`llm_summary`）直接全文展示（第 34-39 行），没有任何折叠。一个摘要可能有好几百字，导致列表很难快速扫读。要求：

- AI 摘要默认折叠，只显示前 2-3 行，带"展开全文"按钮
- 原始 Abstract 已经有 `line-clamp-3`（第 44 行）限制，这是对的，AI 摘要也要做类似处理
- 展开后可以收起

------

### 前后端协作要求

**【协作 #1】统一 API 响应格式和错误处理**

当前前端的错误处理分两种：`console.error`（`page.tsx:49`）和 `alert()`（`page.tsx:79、82`），后端错误返回没有统一格式。要求：

- 后端统一错误响应格式：`{ "status": "error", "code": "INVALID_PARAMS", "message": "..." }`
- 前端替换所有 `alert()` 和 `console.error`，改为页面内的 Toast/通知组件
- 页面加载失败时显示友好的错误状态而非空白页

**【协作 #2】Category 不应该前端硬编码**

当前 `cs.AI OR cs.LG OR cs.CV OR cs.CL` 在前端 `page.tsx:62` 硬编码。要求：

- 后端提供 `GET /api/categories` 或由 `GET /api/stats` 返回可用分类列表
- 前端抓取面板里用多选组件让用户选择分类，而不是写死

------

### 优先级排序

| 优先级 | 任务                       | 负责 | 原因                                   |
| ------ | -------------------------- | ---- | -------------------------------------- |
| **P0** | 后端 #1 任务状态追踪       | 后端 | 用户体验的最大痛点，不知道抓取何时结束 |
| **P0** | 前端 #1 分离抓取与浏览     | 前端 | 当前页面逻辑混乱，是所有 UI 改进的前提 |
| **P0** | 前端 #2 进度反馈           | 前端 | 依赖后端 #1，解决核心用户痛点          |
| **P1** | 前端 #3 分页功能           | 前端 | 用户无法确认结果是否完整               |
| **P1** | 前端 #4 移除 Days to Fetch | 前端 | 消除用户困惑                           |
| **P1** | 后端 #2 修复 days 参数     | 后端 | 消除隐式互斥逻辑                       |
| **P1** | 协作 #1 统一错误处理       | 双方 | 体验基础设施                           |
| **P2** | 后端 #4 重构请求参数       | 后端 | 接口清晰度                             |
| **P2** | 前端 #5 摘要折叠           | 前端 | 列表可读性                             |
| **P2** | 后端 #5 统计端点           | 后端 | 增强信息展示                           |
| **P2** | 协作 #2 分类动态化         | 双方 | 灵活性                                 |
| **P2** | 后端 #3 查询性能           | 后端 | 预防性能瓶颈                           |